---
import { getCollection } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";

export async function getStaticPaths() {
    const cases = await getCollection("cases");
    return cases.map((entry) => ({
        params: { slug: entry.slug },
        props: { entry },
    }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();
const {
    title,
    date,
    status,
    location,
    bureaucracy_score,
    financials,
    timeline,
    cover_image,
    cover_alt,
} = entry.data;

const statusColor =
    status === "Active Investigation" ? "text-red-600" : "text-gray-500";
---

<Layout title={`${title} | The Civic Chronic`}>
    <Header />

    <main
        class="flex-1 w-full max-w-[840px] mx-auto px-6 py-12 md:py-20 flex flex-col gap-16 min-h-screen pt-24"
    >
        <!-- Case Header -->
        <article
            class="flex flex-col gap-6 text-center border-b border-[#e8ebf3] pb-12"
        >
            <div class="flex flex-col items-center gap-3 animate-fade-in-up">
                <span
                    class="inline-flex items-center justify-center px-3 py-1 bg-primary/10 text-primary text-xs font-black tracking-[0.15em] uppercase rounded-sm border border-primary/20"
                >
                    Case File #{entry.slug.toUpperCase()}
                </span>
                <h1
                    class="text-4xl md:text-5xl lg:text-6xl font-black leading-[1.1] tracking-tight text-ink"
                >
                    {title}
                </h1>
                <div
                    class="flex flex-wrap justify-center gap-4 mt-2 text-sm text-gray-500 font-medium font-mono uppercase tracking-wide"
                >
                    <span>Filed: {date.toLocaleDateString()}</span>
                    <span class="text-gray-300">|</span>
                    <span class={`${statusColor} flex items-center gap-1`}>
                        <span class="material-symbols-outlined text-base"
                            >warning</span
                        >
                        Status: {status}
                    </span>
                    <span class="text-gray-300">|</span>
                    <span>Location: {location}</span>
                </div>
            </div>
        </article>

        <!-- Document Preview -->
        {
            cover_image && (
                <figure class="w-full relative group">
                    <div class="absolute inset-0 bg-primary/5 -rotate-1 rounded-sm scale-[1.02] transition-transform group-hover:rotate-0 group-hover:scale-100 z-0" />
                    <div class="relative z-10 w-full bg-white p-2 border border-[#e8ebf3] shadow-sm rounded-sm">
                        <div
                            class="w-full h-[300px] md:h-[400px] bg-cover bg-center grayscale contrast-[1.1] opacity-90 rounded-sm relative overflow-hidden"
                            style={`background-image: url('${cover_image}');`}
                        >
                            <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent" />
                            <div class="absolute bottom-4 left-4 text-white text-xs font-mono bg-black/70 px-2 py-1 rounded-sm">
                                Exhibit A: Photographic Evidence
                            </div>
                        </div>
                    </div>
                    <figcaption class="mt-3 text-center text-xs text-gray-500 italic">
                        Fig 1.1: {cover_alt}
                    </figcaption>
                </figure>
            )
        }

        <!-- Case Overview (Content) -->
        <section class="grid grid-cols-1 gap-4">
            <header
                class="flex items-center gap-4 border-b-2 border-black pb-2 mb-2"
            >
                <span class="material-symbols-outlined">description</span>
                <h3
                    class="text-lg font-bold uppercase tracking-widest text-ink"
                >
                    Case Overview
                </h3>
            </header>
            <div
                class="prose prose-lg max-w-none text-gray-800 leading-relaxed prose-headings:font-serif prose-headings:font-bold prose-strong:text-primary"
            >
                <Content />
            </div>
        </section>

        <!-- Timeline -->
        {
            timeline && timeline.length > 0 && (
                <section class="grid grid-cols-1 gap-6">
                    <header class="flex items-center gap-4 border-b-2 border-black pb-2 mb-2">
                        <span class="material-symbols-outlined">history</span>
                        <h3 class="text-lg font-bold uppercase tracking-widest text-ink">
                            Timeline of Events
                        </h3>
                    </header>
                    <div class="relative pl-8 md:pl-0">
                        <div class="absolute left-8 md:left-1/2 top-0 bottom-0 w-px bg-gray-300 -translate-x-1/2" />
                        {timeline.map((event, index) => (
                            <div
                                class={`relative mb-12 md:flex items-center group ${index % 2 === 0 ? "md:justify-between" : "md:flex-row-reverse md:justify-between"}`}
                            >
                                <div
                                    class={`hidden md:block w-[45%] ${index % 2 === 0 ? "text-right pr-8" : "text-left pl-8"}`}
                                >
                                    <h4 class="text-xl font-bold text-ink">
                                        {event.title}
                                    </h4>
                                    <p class="text-sm text-gray-500 mt-1">
                                        {event.description}
                                    </p>
                                </div>
                                <div
                                    class={`absolute left-8 md:left-1/2 -translate-x-1/2 w-4 h-4 rounded-full border-4 z-10 shadow-sm ${event.type === "failure" ? "bg-red-500 border-white" : "bg-primary border-white"}`}
                                />
                                <div
                                    class={`pl-8 md:pl-0 md:w-[45%] ${index % 2 === 0 ? "md:pl-8 md:text-left" : "md:pr-8 md:text-right"}`}
                                >
                                    <span class="inline-block py-1 px-2 bg-gray-100 text-xs font-bold uppercase rounded text-gray-600 mb-2 md:mb-0">
                                        {event.date}
                                    </span>
                                    <div class="md:hidden mt-2">
                                        <h4 class="text-lg font-bold text-ink">
                                            {event.title}
                                        </h4>
                                        <p class="text-sm text-gray-500 mt-1">
                                            {event.description}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </section>
            )
        }

        <!-- Financial Impact -->
        <section
            class="bg-white border border-[#e8ebf3] p-6 md:p-10 rounded-lg shadow-sm"
        >
            <header class="flex items-center gap-4 mb-8">
                <span class="material-symbols-outlined text-primary text-3xl"
                    >attach_money</span
                >
                <h3
                    class="text-lg font-bold uppercase tracking-widest text-ink"
                >
                    Financial Impact Assessment
                </h3>
            </header>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-12">
                <div class="flex flex-col gap-1">
                    <span
                        class="text-sm font-medium text-gray-500 uppercase tracking-wider"
                        >Total Waste</span
                    >
                    <span
                        class="text-4xl md:text-5xl font-black text-ink tracking-tighter"
                        >{financials.waste}</span
                    >
                    <span class="text-xs text-red-600 font-bold mt-1"
                        >BUREAUCRACY SCORE: {bureaucracy_score}/100</span
                    >
                </div>
                <div class="flex flex-col gap-4">
                    <div
                        class="flex justify-between items-end border-b border-gray-200 pb-2"
                    >
                        <span class="text-sm font-medium text-gray-600"
                            >Initial Budget</span
                        >
                        <span class="text-xl font-bold font-mono text-ink"
                            >{financials.budget}</span
                        >
                    </div>
                    <div
                        class="flex justify-between items-end border-b border-gray-200 pb-2"
                    >
                        <span class="text-sm font-medium text-gray-600"
                            >Cost Per Capita</span
                        >
                        <span class="text-xl font-bold font-mono text-ink"
                            >{financials.cost_per_capita}</span
                        >
                    </div>
                </div>
            </div>
        </section>

        <!-- Footer for Case -->
        <footer
            class="mt-12 pt-12 border-t border-[#e8ebf3] flex flex-col items-center gap-6 text-center pb-20"
        >
            <div class="flex flex-col items-center gap-2">
                <span class="material-symbols-outlined text-4xl text-gray-300"
                    >inventory_2</span
                >
                <p
                    class="text-sm font-medium text-gray-500 uppercase tracking-widest"
                >
                    End of Record
                </p>
            </div>
            <a href="/archive" class="text-primary hover:underline"
                >Return to Archive</a
            >
        </footer>
    </main>

    <Footer />
</Layout>
